/*  ConfigurableMapViewerCMV
 *  version 1.3.4
 *  Project: http://cmv.io/
 */

define(["dojo/_base/declare","dojo/_base/lang","dojo/_base/array","dojo/aspect","dojo/topic","dojo/query","dojo/dom-construct","dojo/dom-attr","dijit/registry","dijit/_WidgetBase","dijit/_TemplatedMixin","dijit/_Contained","dijit/MenuItem","dijit/MenuSeparator","./_Control","./_DynamicSublayer","./_DynamicFolder","./../plugins/legendUtil","dojo/i18n!./../nls/resource"],function(a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s){var t=a([j,k,l,o],{_layerType:"overlay",_esriLayerType:"dynamic",_hasSublayers:!1,_visLayersHandler:null,constructor:function(){this._sublayerControls=[]},_layerTypePreInit:function(){this.layer.layerInfos.length>1&&this.controlOptions.sublayers&&(this._hasSublayers=!0,this._visLayersHandler=d.after(this.layer,"setVisibleLayers",b.hitch(this,"_onSetVisibleLayers"),!0))},_layerTypeInit:function(){var a=r.isLegend(this.controlOptions.noLegend,this.controller.noLegend);a&&this.controlOptions.sublayers===!0?(this._expandClick(),this._createSublayers(this.layer),d.after(this,"_createSublayers",b.hitch(this,r.dynamicSublayerLegend(this.layer,this.expandNode)))):this.controlOptions.sublayers===!1&&a?(this._expandClick(),r.layerLegend(this.layer,this.expandNode)):this.controlOptions.sublayers!==!0||a?this._expandRemove():(this._expandClick(),d.after(this,"_createSublayers",b.hitch(this,"_removeSublayerLegends")),this._createSublayers(this.layer))},_dynamicToggleMenuItems:function(a){this._hasSublayers&&this.controlOptions.allSublayerToggles!==!1&&(a.addChild(new m({label:s.dynamicSublayersOn,onClick:b.hitch(this,"_toggleAllSublayers",!0)})),a.addChild(new m({label:s.dynamicSublayersOff,onClick:b.hitch(this,"_toggleAllSublayers",!1)})),a.addChild(new n))},_toggleAllSublayers:function(a){c.forEach(this._sublayerControls,function(b){b._setSublayerCheckbox(a)}),this._setVisibleLayers()},_createSublayers:function(a){a.layerInfos.length>1&&c.forEach(a.layerInfos,b.hitch(this,function(b){var c,d=b.parentLayerId,e=b.subLayerIds,f=a.id+"-"+b.id+"-sublayer-control";-1===d&&null===e?(c=new p({id:f,control:this,sublayerInfo:b,icons:this.icons}),g.place(c.domNode,this.expandNode,"last")):-1===d&&null!==e?(c=new q({id:f,control:this,sublayerInfo:b,icons:this.icons}),g.place(c.domNode,this.expandNode,"last")):-1!==d&&null!==e?(c=new q({id:f,control:this,sublayerInfo:b,icons:this.icons}),g.place(c.domNode,i.byId(a.id+"-"+b.parentLayerId+"-sublayer-control").expandNode,"last")):-1!==d&&null===e&&(c=new p({id:f,control:this,sublayerInfo:b,icons:this.icons}),g.place(c.domNode,i.byId(a.id+"-"+b.parentLayerId+"-sublayer-control").expandNode,"last")),c.startup(),this._sublayerControls.push(c)}))},_removeSublayerLegends:function(){c.forEach(this._sublayerControls,function(a){a.sublayerInfo.subLayerIds||g.destroy(a.expandClickNode)})},_setVisibleLayers:function(){this._visLayersHandler.remove();var a=this.layer,g=[];c.forEach(f("."+a.id+"-layerControlSublayerCheck"),function(a){"checked"===h.get(a,"data-checked")&&g.push(parseInt(h.get(a,"data-sublayer-id"),10))}),c.forEach(a.layerInfos,function(a){null!==a.subLayerIds&&-1===c.indexOf(g,a.id)?c.forEach(a.subLayerIds,function(a){-1!==c.indexOf(g,a)&&g.splice(c.indexOf(g,a),1)}):null!==a.subLayerIds&&-1!==c.indexOf(g,a.id)&&g.splice(c.indexOf(g,a.id),1)}),g.length||g.push(-1),a.setVisibleLayers(g),a.refresh(),e.publish("layerControl/setVisibleLayers",{id:a.id,visibleLayers:g}),this._visLayersHandler=d.after(this.layer,"setVisibleLayers",b.hitch(this,"_onSetVisibleLayers"),!0)},_onSetVisibleLayers:function(a){var b=[];c.forEach(this.layer.layerInfos,function(d){-1!==c.indexOf(a,d.id)&&b.push(d.id),-1!==d.parentLayerId&&-1===c.indexOf(b,d.parentLayerId)&&b.push(d.parentLayerId)}),c.forEach(this._sublayerControls,function(a){-1!==c.indexOf(b,a.sublayerInfo.id)?a._setSublayerCheckbox(!0):a._setSublayerCheckbox(!1)})}});return t});
